<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生徒連絡用DB</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body, button, input, textarea, div, span, p, h1, h2, h3, h4, h5, h6, select, option {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }

        body {
            background-color: #F0F2F5;
            color: #333333;
            overflow: hidden;
        }

        .text-date { font-size: 3.5rem; letter-spacing: 0.05em; line-height: 1; font-weight: 800; } 
        .text-notice-title { font-size: 2.3rem; line-height: 1.2; font-weight: 800; }
        
        .glass-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .notice-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 0 2rem;
            display: flex;
            align-items: center;
            height: 7.0rem; 
            margin-bottom: 0.8rem;
        }

        .status-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-right: 10px;
        }
        .dot-gray { background-color: #4B5563; }
        .dot-blue { background-color: #2563EB; }
        .dot-green { background-color: #10B981; }

        .icon-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 130px;
            flex-shrink: 0;
            margin-right: 1.5rem;
        }

        .teacher-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.4rem 0.8rem;
            border-radius: 0.75rem;
            border: 3px solid #7dd3fc;
            background-color: #f0f9ff;
            color: #0369a1;
            font-weight: 800;
            font-size: 1.3rem;
            text-align: center;
            line-height: 1;
            min-width: 110px;
        }

        .ticker-wrap { width: 100%; overflow: hidden; white-space: nowrap; display: flex; align-items: center; }
        .ticker-content { display: inline-block; padding-left: 100%; animation: ticker 40s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        @keyframes slideUpFade { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .anim-cascade { animation: slideUpFade 0.5s ease-out forwards; }

        .tab-btn { border-bottom: 6px solid transparent; color: #9CA3AF; transition: all 0.3s ease; }
        .tab-btn.active { color: #2563EB; border-bottom-color: #2563EB; background-color: #EFF6FF; font-weight: 800; }
        
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .change-card {
            background-color: white; 
            padding: 1.2rem 1.5rem; 
            border-radius: 1rem; 
            margin-bottom: 1rem;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            min-height: 6rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        }

        .day-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.4rem 1.2rem;
            border-radius: 1rem;
            border: 4px solid currentColor;
            font-weight: 800;
            font-size: 2.2rem;
            line-height: 1;
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-[#F0F2F5]">

    <div id="loading" class="loading-overlay">
        <p class="text-3xl font-bold text-blue-600">Connecting...</p>
    </div>

    <div id="screen-entrance" class="absolute inset-0 z-50 flex flex-col items-center justify-center space-y-8 bg-[#F0F2F5]">
        <h1 class="text-5xl font-bold text-gray-700">生徒連絡用DB</h1>
        <button onclick="showScreen('dashboard')" class="w-80 bg-blue-600 text-white py-6 rounded-2xl shadow-lg text-2xl font-bold hover:scale-105 transition">大画面表示</button>
        <button onclick="showScreen('edit')" class="w-80 bg-gray-700 text-white py-6 rounded-2xl shadow-lg text-2xl font-bold hover:scale-105 transition">データ入力・管理</button>
    </div>

    <div id="screen-dashboard" class="hidden h-full flex flex-col">
        <div class="p-6 pb-2 space-y-6">
            <div class="flex items-center h-24 space-x-6">
                <div class="glass-card px-10 h-full flex items-center justify-center bg-white flex-shrink-0">
                    <p class="text-date text-gray-700" id="current-date">--月--日</p>
                </div>
                <div class="flex-1 h-full flex items-center overflow-hidden px-6">
                    <div id="top-event-container" class="text-5xl text-gray-700 font-bold truncate w-full">（行事予定なし）</div>
                </div>
            </div>
        </div>

        <div id="dashboard-main-content" class="flex-1 px-6 pb-4 overflow-hidden"></div>

        <div id="urgent-footer" class="h-20 bg-white border-t-4 border-gray-300 flex items-center shadow-sm px-4">
            <div id="urgent-badge-container" class="pl-4 pr-6 bg-white h-full flex items-center z-10 flex-shrink-0">
                <span class="text-red-600 text-3xl font-bold">臨時</span>
            </div>
            <div class="flex-1 overflow-hidden h-full flex items-center mr-4">
                <div id="ticker-container" class="ticker-wrap">
                    <div id="urgent-text-container" class="text-4xl font-bold">久慈翔北高校　生徒用デジタル掲示板</div>
                </div>
            </div>
            <div class="h-full flex items-center justify-center flex-shrink-0 bg-white border-l pl-4">
                 <div id="qrcode"></div>
            </div>
        </div>
    </div>

    <div id="screen-edit" class="hidden h-full bg-gray-50 fixed inset-0 z-50 overflow-hidden flex flex-col">
        <div class="bg-white px-4 py-4 shadow flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-700">データ入力・管理</h2>
            <button onclick="showScreen('entrance')" class="text-blue-600 font-bold border border-blue-600 px-4 py-2 rounded-lg">終了</button>
        </div>
        <div class="flex bg-white shadow-sm z-10">
            <button onclick="switchEditTab('notice')" id="tab-notice" class="tab-btn flex-1 py-5 text-lg font-bold">連絡事項</button>
            <button onclick="switchEditTab('schedule')" id="tab-schedule" class="tab-btn flex-1 py-5 text-lg font-bold">時間割変更</button>
        </div>
        <div id="view-edit-notice" class="flex-1 flex flex-col overflow-hidden">
            <div class="p-4 bg-white shadow-sm"><button onclick="openModal('create')" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md">+ 連絡事項を新規作成</button></div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="edit-list-container"></div>
        </div>
        <div id="view-edit-schedule" class="flex-1 flex flex-col overflow-hidden hidden">
            <div class="p-4 bg-white shadow-sm"><button onclick="openScheduleModal()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-md">+ 時間割変更を追加</button></div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="edit-schedule-list-container"></div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 space-y-4">
            <div class="flex justify-between items-center border-b pb-2"><h3 id="modal-title" class="font-bold text-lg">編集</h3><button onclick="closeModal()" class="text-2xl">&times;</button></div>
            <div><label class="block text-sm font-bold text-gray-600 mb-1">投稿者</label><select id="modal-select-teacher" class="w-full p-3 border-2 rounded-xl bg-white font-bold"></select></div>
            <div class="flex justify-center space-x-2">
                <label class="cursor-pointer"><input type="radio" name="modalType" value="event" class="peer hidden"><div class="px-4 py-2 rounded-lg border-2 peer-checked:border-green-500 peer-checked:text-green-600 peer-checked:bg-green-50 font-bold">行事</div></label>
                <label class="cursor-pointer"><input type="radio" name="modalType" value="urgent" class="peer hidden"><div class="px-4 py-2 rounded-lg border-2 peer-checked:border-red-500 peer-checked:text-red-600 peer-checked:bg-red-50 font-bold">臨時</div></label>
                <label class="cursor-pointer"><input type="radio" name="modalType" value="student" class="peer hidden" checked><div class="px-4 py-2 rounded-lg border-2 peer-checked:border-blue-500 peer-checked:text-blue-600 peer-checked:bg-blue-50 font-bold">生徒</div></label>
            </div>
            <input type="text" id="modal-input-title" class="w-full p-4 border-2 rounded-xl outline-none focus:border-blue-500 text-lg" placeholder="内容を入力...">
            <div class="flex flex-col space-y-2">
                <button onclick="saveData()" id="btn-save" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg shadow">保存する</button>
                <button onclick="deleteData()" id="btn-delete" class="hidden w-full bg-white text-red-500 border border-red-500 py-3 rounded-xl font-bold">このデータを削除</button>
            </div>
        </div>
    </div>

    <div id="schedule-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 space-y-4">
            <div class="flex justify-between items-center border-b pb-2"><h3 class="font-bold text-lg">時間割変更の追加</h3><button onclick="closeScheduleModal()" class="text-2xl">&times;</button></div>
            <div class="flex space-x-1">
                <label class="flex-1 cursor-pointer"><input type="radio" name="schDay" value="today" class="peer hidden" checked><div class="py-2 rounded-lg border-2 text-center peer-checked:border-blue-500 peer-checked:bg-blue-50 font-bold text-xs">今日<br><span id="label-today"></span></div></label>
                <label class="flex-1 cursor-pointer"><input type="radio" name="schDay" value="tomorrow" class="peer hidden"><div class="py-2 rounded-lg border-2 text-center peer-checked:border-green-500 peer-checked:text-green-600 peer-checked:bg-green-50 font-bold text-xs">明日<br><span id="label-tomorrow"></span></div></label>
                <label class="flex-1 cursor-pointer"><input type="radio" name="schDay" value="afterNext" class="peer hidden"><div class="py-2 rounded-lg border-2 text-center peer-checked:border-orange-500 peer-checked:text-orange-600 peer-checked:bg-orange-50 font-bold text-xs">明後日<br><span id="label-afternext"></span></div></label>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <select id="sch-class" class="p-3 border-2 rounded-xl bg-white font-bold"></select>
                <select id="sch-period" class="p-3 border-2 rounded-xl bg-white font-bold">
                    <option value="1">1校時</option><option value="2">2校時</option><option value="3">3校時</option>
                    <option value="4">4校時</option><option value="5">5校時</option><option value="6">6校時</option>
                </select>
            </div>
            <select id="sch-subject" class="w-full p-3 border-2 rounded-xl bg-white font-bold"></select>
            <button onclick="saveSchedule()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg shadow">変更を追加</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            classes: ['TE1', 'ME2', 'CE2', 'ME3', 'CE3'],
            subjects: ['数学Ⅰ', '数学Ⅱ', '国語表現', '言語文化', '地理総合', '物理', '化学', '英語Co', '体育', '芸術', '家庭基礎', '情報Ⅰ', 'LHR'],
            teachers: [
                { name: '佐藤' }, { name: '鈴木' }, { name: '高橋' }, { name: '田中' }, { name: '伊藤' }, 
                { name: '渡辺' }, { name: '山本' }, { name: '中村' }, { name: '小林' }, { name: '加藤' }, 
                { name: '吉田' }, { name: '山田' }, { name: '佐々木' }, { name: '山口' }, { name: '松本' }, 
                { name: '井上' }, { name: '木村' }, { name: '林' }, { name: '斎藤' }, { name: '清水' }, 
                { name: '山崎' }, { name: '阿部' }, { name: '森' }, { name: '池田' }, { name: '橋本' }
            ]
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAb5GbSvT8YCOJt6LYGWxLQvQLspFU3nWM",
            authDomain: "school-map-quest.firebaseapp.com",
            databaseURL: "https://school-map-quest-default-rtdb.firebaseio.com",
            projectId: "school-map-quest",
            storageBucket: "school-map-quest.firebasestorage.app",
            messagingSenderId: "966814904764",
            appId: "1:966814904764:web:e89a5c3cc542cdd56fbbb9",
            measurementId: "G-1E4P6SZ7ZF"
        };

        let notices = [], scheduleData = [];
        let noticesRef, scheduleRef;
        let globalPageIndex = 0;
        const ITEMS_PER_PAGE = 5; 

        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            noticesRef = db.ref('notices');
            scheduleRef = db.ref('schedule_changes');
            firebase.auth().signInAnonymously().then(() => {
                document.getElementById('loading').classList.add('hidden');
            });
            noticesRef.on('value', (snapshot) => {
                const data = snapshot.val(); notices = [];
                if (data) Object.keys(data).forEach(key => notices.push({ id: key, ...data[key] }));
                notices.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                updateAllViews();
            });
            scheduleRef.on('value', (snapshot) => {
                const data = snapshot.val(); scheduleData = [];
                if (data) Object.keys(data).forEach(key => scheduleData.push({ id: key, ...data[key] }));
                cleanupOldData(); updateAllViews();
            });
        } catch (e) { console.error(e); }

        function cleanupOldData() {
            const todayStr = getYmd(new Date());
            scheduleData.forEach(item => { if (item.targetDate && item.targetDate < todayStr) scheduleRef.child(item.id).remove(); });
        }

        function updateAllViews() {
            if (!document.getElementById('screen-dashboard').classList.contains('hidden')) updateDashboard();
            if (!document.getElementById('screen-edit').classList.contains('hidden')) { renderEditList(); renderScheduleEditList(); }
        }

        function showScreen(screenId) {
            ['screen-entrance', 'screen-dashboard', 'screen-edit'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('screen-' + screenId).classList.remove('hidden');
            if (screenId === 'dashboard') {
                updateDate(); generateQRCode(); globalPageIndex = 0; updateDashboard();
                if(window.pageInterval) clearInterval(window.pageInterval);
                window.pageInterval = setInterval(nextPage, 10000);
            } else if (screenId === 'edit') { renderEditList(); renderScheduleEditList(); switchEditTab('notice'); }
        }

        function getYmd(date) {
            const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getDisplayDate(date) {
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            return `${date.getMonth() + 1}月${date.getDate()}日(${days[date.getDay()]})`;
        }

        function nextPage() {
            const studentNotices = notices.filter(n => n.target === 'student');
            const totalNoticePages = Math.ceil(studentNotices.length / ITEMS_PER_PAGE) || 1;
            const totalPages = 1 + totalNoticePages;
            globalPageIndex = (globalPageIndex + 1) % totalPages;
            updateDashboard();
        }

        function updateDashboard() {
            updateTopEventDisplay(); updateBottomUrgentTicker(); updateDate();
            const container = document.getElementById('dashboard-main-content');
            container.innerHTML = '';
            if (globalPageIndex === 0) renderSchedulePage(container); else renderNoticePage(container, globalPageIndex - 1);
        }

        function renderSchedulePage(container) {
            const today = new Date();
            const todayStr = getYmd(today);
            const tomorrow = new Date(); tomorrow.setDate(today.getDate() + 1);
            const tomorrowStr = getYmd(tomorrow);

            const filterAndSort = (dateStr) => {
                const filtered = scheduleData.filter(s => s.targetDate === dateStr);
                const grouped = {};
                filtered.forEach(s => { if(!grouped[s.class]) grouped[s.class] = []; grouped[s.class].push(s); });
                return Object.keys(grouped).sort((a,b) => CONFIG.classes.indexOf(a) - CONFIG.classes.indexOf(b)).map(cls => ({
                    class: cls, items: grouped[cls].sort((a,b) => a.period - b.period)
                }));
            };

            const todayGroups = filterAndSort(todayStr);
            const tomorrowGroups = filterAndSort(tomorrowStr);

            const wrap = document.createElement('div');
            wrap.className = "flex h-full space-x-8 anim-cascade";
            
            const createColumn = (label, dateObj, groups, textColor, badgeBg) => {
                const dateText = getDisplayDate(dateObj);
                let html = `
                    <div class="flex-1 flex flex-col h-full overflow-hidden">
                        <div class="pb-5 pl-2 flex items-center">
                            <div class="day-badge ${textColor} ${badgeBg}">${label}</div>
                            <span class="text-4xl ml-5 font-extrabold ${textColor}">${dateText} の時間割変更</span>
                        </div>
                        <div class="flex-1 overflow-hidden">
                `;
                if (groups.length === 0) {
                    html += `<p class="text-gray-400 text-3xl p-8 text-center mt-10">${label}の変更はありません</p>`;
                } else {
                    groups.forEach(g => {
                        let rows = g.items.map(i => `<div class="flex items-center mb-2"><span class="text-lg bg-gray-200 px-3 py-0.5 rounded-lg text-gray-600 mr-3 font-bold w-24 text-center">${i.period}校時</span><span class="text-2xl font-bold text-gray-700">${i.subject}</span></div>`).join('');
                        html += `
                            <div class="change-card">
                                <div class="flex flex-col items-center justify-center w-24 flex-shrink-0">
                                    <div class="font-bold text-gray-700 text-3xl leading-none">${g.class}</div>
                                </div>
                                <div class="flex-1 px-4 flex flex-col justify-center">${rows}</div>
                            </div>
                        `;
                    });
                }
                html += `</div></div>`;
                return html;
            };

            wrap.innerHTML = 
                createColumn("今日", today, todayGroups, "text-blue-600", "bg-blue-50") + 
                createColumn("明日", tomorrow, tomorrowGroups, "text-green-600", "bg-green-50");
            container.appendChild(wrap);
        }

        function renderNoticePage(container, pageIdx) {
            const list = notices.filter(n => n.target === 'student');
            const start = pageIdx * ITEMS_PER_PAGE;
            const displayList = list.slice(start, start + ITEMS_PER_PAGE);

            let html = `
                <div class="w-full flex flex-col h-full anim-cascade">
                    <div class="pb-5 pl-2 flex items-center">
                        <span class="text-4xl font-extrabold text-gray-600">連絡事項 (${pageIdx + 1}/${Math.ceil(list.length/ITEMS_PER_PAGE) || 1})</span>
                    </div>
                    <div class="flex-1">
            `;

            if (displayList.length === 0) {
                html += `<div class='text-gray-400 text-3xl p-8 text-center mt-10'>表示する連絡はありません</div>`;
            } else {
                displayList.forEach((n, i) => {
                    const teacherName = n.teacherName || '不明';
                    html += `
                        <div class="notice-card w-full bg-white" style="animation-delay: ${i * 0.1}s">
                            <div class="icon-section">
                                <div class="teacher-badge">${teacherName}</div>
                            </div>
                            <h3 class="text-notice-title text-gray-800 truncate w-full pt-1">${n.title}</h3>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
            container.innerHTML = html;
        }

        function updateTopEventDisplay() {
            const list = notices.filter(n => n.target === 'event').map(n => n.title);
            document.getElementById('top-event-container').textContent = list.length ? list.join("　　/　　") : "（行事予定なし）";
        }
        function updateBottomUrgentTicker() {
            const badge = document.getElementById('urgent-badge-container');
            const container = document.getElementById('urgent-text-container');
            const list = notices.filter(n => n.target === 'urgent').map(n => n.title);
            if (list.length > 0) {
                badge.classList.remove('hidden'); container.textContent = list.join("　　　　");
                container.className = "ticker-content text-4xl text-red-600 font-bold";
            } else {
                badge.classList.add('hidden'); container.textContent = "久慈翔北高校　生徒用デジタル掲示板";
                container.className = "text-4xl text-black font-bold px-4 text-left"; 
            }
        }
        function switchEditTab(tab) {
            const btnNotice = document.getElementById('tab-notice'); const btnSchedule = document.getElementById('tab-schedule');
            const viewNotice = document.getElementById('view-edit-notice'); const viewSchedule = document.getElementById('view-edit-schedule');
            if (tab === 'notice') { btnNotice.classList.add('active'); btnSchedule.classList.remove('active'); viewNotice.classList.remove('hidden'); viewSchedule.classList.add('hidden'); }
            else { btnSchedule.classList.add('active'); btnNotice.classList.remove('active'); viewSchedule.classList.remove('hidden'); viewNotice.classList.add('hidden'); }
        }
        function renderEditList() {
            const container = document.getElementById('edit-list-container'); container.innerHTML = '';
            if (notices.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 py-10">データがありません</p>'; return; }
            notices.forEach(n => {
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-xl shadow-sm border flex items-center justify-between cursor-pointer active:bg-gray-50";
                item.onclick = () => openModal('edit', n.id);
                let bClass = n.target === 'urgent' ? 'bg-red-100 text-red-600' : (n.target === 'event' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600');
                item.innerHTML = `<div class="flex items-center"><span class="${bClass} text-xs font-bold px-2 py-1 rounded mr-3">${n.target==='urgent'?'臨時':(n.target==='event'?'行事':'生徒')}</span><span class="font-bold text-gray-700">${n.title}</span></div><span class="text-gray-300">修正 &rsaquo;</span>`;
                container.appendChild(item);
            });
        }
        function openModal(mode, id = null) {
            window.currentEditId = id; document.getElementById('edit-modal').classList.remove('hidden');
            const teacherSelect = document.getElementById('modal-select-teacher');
            teacherSelect.innerHTML = CONFIG.teachers.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            const deleteBtn = document.getElementById('btn-delete');
            if (mode === 'create') { document.getElementById('modal-title').textContent = "新規作成"; document.getElementById('modal-input-title').value = ""; deleteBtn.classList.add('hidden'); }
            else {
                const data = notices.find(n => n.id === id);
                document.getElementById('modal-title').textContent = "修正"; document.getElementById('modal-input-title').value = data.title;
                teacherSelect.value = data.teacherName || ''; deleteBtn.classList.remove('hidden');
                document.querySelector(`input[name="modalType"][value="${data.target}"]`).checked = true;
            }
        }
        function closeModal() { document.getElementById('edit-modal').classList.add('hidden'); }
        function saveData() {
            const id = window.currentEditId; const title = document.getElementById('modal-input-title').value;
            const teacherName = document.getElementById('modal-select-teacher').value;
            if(!title) return alert("内容を入力してください");
            const type = document.querySelector('input[name="modalType"]:checked').value;
            const payload = { title, target: type, teacherName, timestamp: id ? notices.find(n=>n.id===id).timestamp : Date.now() };
            if (id) noticesRef.child(id).update(payload); else noticesRef.push(payload); closeModal();
        }
        function deleteData() { if(confirm("削除しますか？")) { noticesRef.child(window.currentEditId).remove(); closeModal(); } }
        function renderScheduleEditList() {
            const container = document.getElementById('edit-schedule-list-container'); container.innerHTML = '';
            const todayStr = getYmd(new Date()); const filtered = scheduleData.filter(s => s.targetDate >= todayStr);
            if (filtered.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 py-10">データがありません</p>'; return; }
            filtered.sort((a,b)=> (a.timestamp || 0) - (b.timestamp || 0)).forEach(s => {
                const item = document.createElement('div');
                item.className = "bg-white p-4 rounded-xl shadow-sm border mb-2 flex justify-between items-center cursor-pointer active:bg-gray-50";
                item.onclick = () => { if(confirm("削除しますか？")) scheduleRef.child(s.id).remove(); };
                item.innerHTML = `<div class="flex items-center"><span class="text-xs font-bold bg-gray-100 px-2 py-1 rounded mr-3">${s.targetDate}</span><span class="font-bold text-blue-600 inline-block w-14">${s.class}</span><span class="font-bold text-gray-700">${s.period}校時 ${s.subject}</span></div><span class="text-red-400 font-bold ml-4">削除</span>`;
                container.appendChild(item);
            });
        }
        function openScheduleModal() {
            document.getElementById('schedule-modal').classList.remove('hidden');
            const today = new Date(); const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1); const afterNext = new Date(today); afterNext.setDate(today.getDate()+2);
            document.getElementById('label-today').textContent = getDisplayDate(today); document.getElementById('label-tomorrow').textContent = getDisplayDate(tomorrow); document.getElementById('label-afternext').textContent = getDisplayDate(afterNext);
            document.getElementById('sch-class').innerHTML = CONFIG.classes.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('sch-subject').innerHTML = CONFIG.subjects.map(s => `<option value="${s}">${s}</option>`).join('');
        }
        function closeScheduleModal() { document.getElementById('schedule-modal').classList.add('hidden'); }
        function saveSchedule() {
            const dayMode = document.querySelector('input[name="schDay"]:checked').value; const dateObj = new Date();
            if(dayMode === 'tomorrow') dateObj.setDate(dateObj.getDate()+1); else if(dayMode === 'afterNext') dateObj.setDate(dateObj.getDate()+2);
            const payload = { targetDate: getYmd(dateObj), class: document.getElementById('sch-class').value, period: document.getElementById('sch-period').value, subject: document.getElementById('sch-subject').value, timestamp: Date.now() };
            scheduleRef.push(payload); closeScheduleModal();
        }
        function generateQRCode() {
            const container = document.getElementById('qrcode'); container.innerHTML = "";
            new QRCode(container, { text:"https://kjs-hs.note.jp", width: 64, height: 64 });
        }
        function updateDate() {
            const el = document.getElementById('current-date'); if(el) el.textContent = getDisplayDate(new Date());
        }
        switchEditTab('notice');
    </script>
</body>
</html>