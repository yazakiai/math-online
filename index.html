<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>数学オンライン（仮）</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; touch-action: manipulation; }
        .hidden-screen { display: none !important; }
        
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
        
        .answer-dock { box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }

        .reveal-row { transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .reveal-row.active {
            transform: scale(1.02);
            background-color: #fff;
            z-index: 50;
            border-color: transparent;
        }
        
        .bg-correct { background-color: #10B981 !important; } 
        .bg-wrong { background-color: #9CA3AF !important; }

        .review-mode .input-area { display: none; }
        .review-mode .review-controls { display: flex !important; }

        .math-input-container { position: relative; }
        .math-input-real {
            color: transparent;
            caret-color: #2563EB;
            background: transparent;
            z-index: 10;
            position: relative;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .math-input-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Left align */
            padding-left: 1rem;
            z-index: 5;
            color: #374151;
            overflow: hidden;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        
        /* Mobile Safe Area Padding */
        .safe-top-padding { padding-top: calc(env(safe-area-inset-top) + 20px); }

        /* Compact Keypad Styling */
        .keypad-btn {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            height: 44px;
            padding: 0;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .keypad-btn:active { background-color: #d1d5db; transform: scale(0.95); }
        .keypad-btn.action { background-color: #fee2e2; color: #b91c1c; font-size: 1rem; }
        .keypad-btn.submit { background-color: #2563eb; color: white; border: none; font-size: 0.9rem; letter-spacing: 0.05em; }
        .keypad-btn.submit:active { background-color: #1d4ed8; }

        /* Problem Text Wrapping */
        #problem-text {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.8;
        }
        .katex-display { margin: 0.5em 0; overflow-x: auto; overflow-y: hidden; }

        /* Custom Scroll for Lists */
        .custom-list-scroll {
            max-height: 40vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen w-screen overflow-hidden safe-top-padding">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center hidden-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <section id="screen-login" class="h-full flex flex-col justify-center items-center p-6">
        <div class="bg-white p-10 rounded-2xl shadow-sm max-w-md w-full border border-gray-100">
            <h1 class="text-3xl font-bold text-center mb-2 tracking-tight">数学オンライン（仮）</h1>
            <p class="text-gray-400 text-center mb-8 text-sm">ようこそ</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">ユーザー名</label>
                    <input type="text" id="input-username" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="例: Euler">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">パスコード</label>
                    <input type="password" id="input-passcode" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="4桁以上の数字">
                </div>
                <button id="btn-login" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3 rounded-lg transition transform active:scale-95 shadow-lg mt-4">
                    ログイン
                </button>
            </div>
            <div class="mt-6 text-center text-[10px] text-gray-400">
                ※不適切な名前や、他者を不快にする表現は禁止です
            </div>
        </div>
    </section>

    <section id="screen-lobby" class="hidden-screen h-full flex flex-col p-6 max-w-5xl mx-auto pt-24">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold" id="lobby-username">Loading...</h2>
                <div class="flex items-center space-x-2 text-sm text-gray-500">
                    <span class="bg-gray-200 px-2 py-0.5 rounded text-xs font-bold">レート</span>
                    <span class="font-mono text-lg text-blue-600 font-bold" id="lobby-rate">----</span>
                </div>
            </div>
            <button onclick="location.reload()" class="text-sm text-gray-400 hover:text-gray-600 font-bold">Logout</button>
        </header>

        <div class="flex-1 overflow-y-auto pr-2 pb-10">
            <div class="mb-8">
                <h3 class="text-sm font-bold text-blue-600 mb-4 tracking-widest flex items-center sticky top-0 bg-gray-100 py-2 z-10">
                    <span class="w-2 h-2 rounded-full bg-blue-600 mr-2 animate-pulse"></span>
                    募集中
                </h3>
                <div id="event-list-active" class="space-y-3"></div>
            </div>

            <div>
                <h3 class="text-sm font-bold text-gray-400 mb-4 tracking-widest border-t border-gray-200 pt-8 sticky top-0 bg-gray-100 py-2 z-10">終了</h3>
                <div id="event-list-archive" class="space-y-3"></div>
                <button id="btn-show-more-archive" class="hidden w-full text-center text-xs text-gray-400 py-3 hover:text-gray-600">
                    + Show All Archives
                </button>
            </div>
        </div>
    </section>

    <section id="screen-waiting" class="hidden-screen h-full flex flex-col bg-white text-gray-800 relative pt-20">
        <div class="flex-none text-center px-6">
            <p class="text-blue-600 font-bold tracking-widest text-sm mb-2">待機中</p>
            <div class="text-6xl font-mono font-bold mb-4 tracking-tighter text-gray-900" id="countdown">--:--</div>
            <p class="text-gray-400 text-xs animate-pulse mb-6">開始までお待ちください</p>
        </div>
        
        <div class="flex-1 bg-gray-50 border-t border-gray-100 rounded-t-3xl shadow-inner p-6 overflow-hidden flex flex-col">
            <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-wider">参加者リスト</h3>
            <div id="waiting-participant-list" class="space-y-2 custom-list-scroll pb-20">
                </div>
        </div>

        <button onclick="leaveEventAndBack()" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 text-xs text-gray-400 hover:text-red-500 transition font-bold border border-gray-200 px-4 py-2 rounded-full bg-white shadow-lg">
            待機をキャンセルして戻る
        </button>
    </section>

    <section id="screen-answer" class="hidden-screen h-full flex flex-col bg-gray-50">
        <div class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-20 pt-24">
            <div class="flex items-center space-x-4 flex-shrink-0">
                <span class="bg-gray-900 text-white px-3 py-1 rounded text-sm font-bold tracking-wider whitespace-nowrap">Q.<span id="display-q-num">1</span></span>
                <span class="text-xs font-mono text-red-500 font-bold whitespace-nowrap" id="answer-timer-display">--:--</span>
                <button id="btn-back-lobby-review" class="hidden text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded font-bold text-gray-600 whitespace-nowrap">ロビーへ戻る</button>
            </div>
            <div class="flex-1 overflow-x-auto no-scrollbar ml-4">
                <div class="flex space-x-2 w-max" id="nav-bubbles"></div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 flex justify-center items-start">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 md:p-12 max-w-4xl w-full mt-4 mb-48 relative">
                <div id="review-badge" class="hidden absolute top-4 right-4 bg-gray-100 text-gray-500 text-xs font-bold px-2 py-1 rounded">ARCHIVE VIEW</div>
                <div class="text-xl md:text-3xl leading-relaxed font-medium text-gray-800" id="problem-text"></div>
                <div class="mt-8 pt-8 border-t border-gray-100 text-sm text-gray-400" id="problem-rule"></div>
            </div>
        </div>

        <div class="answer-dock bg-white border-t border-gray-200 p-2 pb-4 z-30 w-full absolute bottom-0">
            <div class="max-w-xl mx-auto">
                <div class="relative input-area mb-2">
                    <div class="flex gap-2 items-center">
                        <div class="flex-1 math-input-container relative bg-gray-50 border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition">
                            <div id="math-overlay" class="math-input-overlay text-xl font-mono"></div>
                            <input type="text" id="answer-input" 
                                class="math-input-real w-full px-4 py-2 text-xl font-mono outline-none text-left tracking-widest" 
                                placeholder="解答を入力..." 
                                oninput="updateMathInput(this.value)"
                                autocomplete="off" readonly>
                        </div>
                    </div>
                </div>
                
                <div id="keypad-area" class="flex flex-col gap-1.5">
                    <div class="grid grid-cols-9 gap-1">
                        <button class="keypad-btn" onclick="kp('1')">1</button>
                        <button class="keypad-btn" onclick="kp('2')">2</button>
                        <button class="keypad-btn" onclick="kp('3')">3</button>
                        <button class="keypad-btn" onclick="kp('4')">4</button>
                        <button class="keypad-btn" onclick="kp('5')">5</button>
                        <button class="keypad-btn" onclick="kp('6')">6</button>
                        <button class="keypad-btn" onclick="kp('7')">7</button>
                        <button class="keypad-btn" onclick="kp('8')">8</button>
                        <button class="keypad-btn" onclick="kp('9')">9</button>
                    </div>
                    <div class="grid grid-cols-6 gap-1">
                        <button class="keypad-btn" onclick="kp('0')">0</button>
                        <button class="keypad-btn" onclick="kp('-')">－</button>
                        <button class="keypad-btn" onclick="kp(',')">,</button>
                        <button class="keypad-btn action" onclick="kp('BS')">⌫</button>
                        <button class="keypad-btn submit col-span-2" onclick="submitCurrentAnswer()">提 出</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="screen-finished" class="hidden-screen h-full flex flex-col bg-gray-50 overflow-y-auto">
        <div class="w-full max-w-2xl mx-auto p-6 my-10 bg-white rounded-xl shadow-sm mt-20">
            <div class="text-center border-b border-gray-100 pb-6 mb-6">
                <div id="finished-waiting-header" class="hidden mb-4">
                     <span class="text-xs font-bold text-gray-400 block mb-1">競技終了まで</span>
                     <span id="finish-wait-timer" class="text-4xl font-mono font-bold text-gray-800 tracking-tight">--:--</span>
                </div>
                
                <h2 class="text-2xl font-bold text-gray-800 mb-2">対戦終了</h2>
                <div class="flex justify-center my-4">
                    <div class="animate-pulse bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-sm font-bold" id="user-status-msg">
                        集計中
                    </div>
                </div>
                <p class="text-gray-500 text-sm">しばらくお待ちください</p>
            </div>
            
            <div id="finished-participant-list-container" class="mb-8 hidden">
                <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider text-left">参加者の進捗</h3>
                <div id="finished-participant-list" class="space-y-2 custom-list-scroll p-2 bg-gray-50 rounded-lg border border-gray-100">
                    </div>
            </div>

            <div id="personal-result-area" class="hidden animate-fade-in">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">おつかれさまでした</h2>
                </div>

                <div class="flex justify-between items-center mb-8 bg-gray-50 p-6 rounded-lg">
                    <div class="text-left">
                        <p class="text-xs text-gray-400 uppercase tracking-widest font-bold">あなたの順位</p>
                        <p class="text-4xl font-bold text-gray-900" id="my-rank-disp">-</p>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <p class="text-xs text-gray-400 uppercase tracking-widest font-bold">レート</p>
                        <p class="text-4xl font-mono font-bold text-blue-600 leading-none" id="my-rate-disp">-</p>
                        <p class="text-sm font-mono font-bold text-green-500 mt-1" id="my-rate-diff"></p>
                    </div>
                </div>
                <h3 class="text-sm font-bold text-gray-400 mb-4 tracking-widest">答え合わせ</h3>
                <div id="answer-review-list" class="space-y-4"></div>
                <div class="mt-8 pt-6 border-t border-gray-100">
                    <button onclick="backToLobby()" class="w-full bg-gray-900 text-white py-3 rounded-lg text-sm font-bold hover:bg-black transition">ロビーへ戻る</button>
                </div>
            </div>
        </div>
    </section>

    <section id="screen-admin" class="hidden-screen h-full flex bg-gray-50 text-gray-800 overflow-hidden">
        <div class="w-1/4 min-w-[320px] p-6 border-r border-gray-200 flex flex-col bg-white shadow-sm z-10 overflow-y-auto">
            <h1 class="text-2xl font-bold mb-1 tracking-tight text-gray-900">数学オンライン（仮）</h1>
            <p class="text-gray-400 tracking-wider text-xs mb-6">管理者ダッシュボード</p>

            <button id="btn-toggle-create" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-3 rounded-lg shadow-sm mb-4 transition flex justify-center items-center">
                <span class="mr-2 text-lg">＋</span> 新規イベント作成
            </button>

            <div id="create-event-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 animate-fade-in">
                <div class="space-y-3">
                    <input type="text" id="new-evt-title" class="w-full text-sm p-2 border rounded" placeholder="イベント名">
                    <div>
                        <label class="text-xs text-gray-400">開始日時</label>
                        <input type="datetime-local" id="new-evt-time" class="w-full text-sm p-2 border rounded">
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400">制限時間(分)</label>
                            <input type="number" id="new-evt-duration" class="w-full text-sm p-2 border rounded" value="5">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs text-gray-400">問題数(1-20)</label>
                            <input type="number" id="new-evt-qcount" class="w-full text-sm p-2 border rounded" value="5" min="1" max="20">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Min Rate</label>
                        <input type="number" id="new-evt-rate" class="w-full text-sm p-2 border rounded" value="0">
                    </div>
                    <button id="btn-create-event" class="w-full bg-gray-800 text-white text-xs py-2 rounded hover:bg-black">作成 (自動進行)</button>
                </div>
            </div>

            <p class="text-xs text-gray-400 uppercase mb-2">イベントリスト</p>
            <div id="admin-event-list" class="space-y-2 flex-1 overflow-y-auto mb-4 min-h-[200px]"></div>
            
            <div class="mt-auto pt-4 border-t border-gray-100">
                <div class="flex justify-center items-center">
                    <img id="qr-code" src="" alt="QR Code" class="w-40 h-40 border border-gray-200 rounded">
                </div>
                <p class="text-[10px] text-gray-400 text-center mt-2">Scan to Join</p>
                <div class="hidden">
                    <button id="btn-stop-duel"></button>
                    <button id="btn-reveal"></button>
                </div>
            </div>
        </div>

        <div class="flex-1 p-6 bg-gray-50 overflow-hidden flex flex-col">
            <div class="flex items-center justify-between mb-4 border-b border-gray-200 pb-2">
                <div id="admin-status-header" class="text-2xl font-bold text-gray-800 flex items-center">
                    <span class="text-gray-400 text-sm">Select Event</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex bg-gray-200 rounded-lg p-0.5">
                        <button onclick="window.setGridSize('lg')" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-white hover:shadow-sm transition">大</button>
                        <button onclick="window.setGridSize('md')" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-white hover:shadow-sm transition">中</button>
                        <button onclick="window.setGridSize('sm')" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-white hover:shadow-sm transition">小</button>
                    </div>
                    <div class="w-px h-4 bg-gray-300"></div>
                    <div class="flex items-center space-x-2">
                        <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                        <span class="text-xs text-gray-400 font-bold">Live</span>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto pt-4 px-2" id="admin-grid-container">
                <div id="admin-grid" class="grid gap-3 content-start"></div>
            </div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHNwaDa4L9tubLe2rKYOqqTsJVFbcgBFo",
            authDomain: "onlineroom-c08eb.firebaseapp.com",
            databaseURL: "https://onlineroom-c08eb-default-rtdb.firebaseio.com",
            projectId: "onlineroom-c08eb",
            storageBucket: "onlineroom-c08eb.firebasestorage.app",
            messagingSenderId: "1046314906343",
            appId: "1:1046314906343:web:43b4f23845e5171ac62842",
            measurementId: "G-6TRWQBMZKV"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- QUESTION BANK (70 Questions) ---
        const QUESTION_BANK = [
            { id: 1, text: "二次方程式 $x^2 - 5x + 6 = 0$ の解を求めよ。小さい順にカンマ区切りで答えよ。", answer: ["2,3"] },
            { id: 2, text: "$n=10$ のとき、式 $n^2 + n + 1$ の値を求めよ。", answer: ["111"] },
            { id: 3, text: "放物線 $y = x^2 - 4x + 9$ の頂点の $y$ 座標を求めよ。", answer: ["5"] },
            { id: 4, text: "等差数列 $3, 7, 11, ...$ の第10項を求めよ。", answer: ["39"] },
            { id: 5, text: "$\\log_{2} 32$ の値を求めよ。", answer: ["5"] },
            { id: 6, text: "ベクトル $\\vec{a}=(3,4)$ の大きさを求めよ。", answer: ["5"] },
            { id: 7, text: "三角形の3辺の長さが $3, 4, 5$ のとき、その面積を求めよ。", answer: ["6"] },
            { id: 8, text: "$\\int_{0}^{2} 3x^2 dx$ を計算せよ。", answer: ["8"] },
            { id: 9, text: "2個のサイコロを同時に投げるとき、和が7になる組み合わせは何通りあるか。", answer: ["6"] },
            { id: 10, text: "連立方程式 $2x+y=7, x-y=2$ の解 $(x,y)$ について、$x+y$ の値を求めよ。", answer: ["4"] },
            { id: 11, text: "$x^2-6x+k=0$ が重解を持つとき、定数 $k$ の値を求めよ。", answer: ["9"] },
            { id: 12, text: "$\\sin 30^\\circ + \\cos 60^\\circ$ の値を求めよ。", answer: ["1"] },
            { id: 13, text: "$100$ の約数の個数を求めよ。", answer: ["9"] },
            { id: 14, text: "初項2、公比3の等比数列の第4項を求めよ。", answer: ["54"] },
            { id: 15, text: "円 $x^2 + y^2 = 25$ 上の点 $(3,4)$ における接線の傾きは $-a/b$ となる。$a+b$ の値を求めよ（$a,b$は互いに素な自然数）。", answer: ["7"] },
            { id: 16, text: "$\\sum_{k=1}^{10} k$ の値を求めよ。", answer: ["55"] },
            { id: 17, text: "2進数 $1011$ を10進数に直せ。", answer: ["11"] },
            { id: 18, text: "男子3人、女子2人が一列に並ぶとき、女子2人が隣り合う並び方は何通りか。", answer: ["48"] },
            { id: 19, text: "$|x-3|=5$ を満たす正の数 $x$ を求めよ。", answer: ["8"] },
            { id: 20, text: "$f(x)=x^3-3x^2+5$ のとき、$f'(2)$ の値を求めよ。", answer: ["0"] },
            { id: 21, text: "$12$ と $18$ の最大公約数を求めよ。", answer: ["6"] },
            { id: 22, text: "$12$ と $18$ の最小公倍数を求めよ。", answer: ["36"] },
            { id: 23, text: "$\\sqrt{12} + \\sqrt{27} = a\\sqrt{3}$ となるとき、$a$ の値を求めよ。", answer: ["5"] },
            { id: 24, text: "関数 $y=2x+3$ のグラフの傾きを求めよ。", answer: ["2"] },
            { id: 25, text: "関数 $y=-3x^2$ について、$x$ が $1$ から $3$ まで増加するときの変化の割合を求めよ。", answer: ["-12"] },
            { id: 26, text: "半径 $5$ の円の面積は $a\\pi$ である。$a$ の値を求めよ。", answer: ["25"] },
            { id: 27, text: "$7\\text{C}_2$ の値を求めよ。", answer: ["21"] },
            { id: 28, text: "$5!$ の値を求めよ。", answer: ["120"] },
            { id: 29, text: "$2^{10}$ の値を求めよ。", answer: ["1024"] },
            { id: 30, text: "$\\sin^2 \\theta + \\cos^2 \\theta$ の値を求めよ。", answer: ["1"] },
            { id: 31, text: "三角形の内角の和は何度か。", answer: ["180"] },
            { id: 32, text: "$x^2-9=0$ の解のうち、正のものを求めよ。", answer: ["3"] },
            { id: 33, text: "$1$ から $100$ までの整数のうち、$5$ の倍数は何個あるか。", answer: ["20"] },
            { id: 34, text: "サイコロを1回投げて、偶数の目が出る確率は $1/a$ である。$a$ の値を求めよ。", answer: ["2"] },
            { id: 35, text: "データ $3, 5, 7, 9, 11$ の平均値を求めよ。", answer: ["7"] },
            { id: 36, text: "$x^2 + 6x + 9$ の解を求めよ。", answer: ["-3"] },
            { id: 37, text: "$\\sqrt{49}$ の値を求めよ。", answer: ["7"] },
            { id: 38, text: "$|-10| + |3|$ の値を求めよ。", answer: ["13"] },
            { id: 39, text: "一次関数 $y=2x-5$ において、$x=4$ のときの $y$ の値を求めよ。", answer: ["3"] },
            { id: 40, text: "底辺が $6$、高さが $5$ の三角形の面積を求めよ。", answer: ["15"] },
            { id: 41, text: "$\\log_{10} 1000$ の値を求めよ。", answer: ["3"] },
            { id: 42, text: "$3^4$ の値を求めよ。", answer: ["81"] },
            { id: 43, text: "$\\sum_{k=1}^{5} k^2$ の値を求めよ。", answer: ["55"] },
            { id: 44, text: "$x+2y=8, 2x-y=6$ の解 $(x,y)$ について $x$ の値を求めよ。", answer: ["4"] },
            { id: 45, text: "二次関数 $y=(x-2)^2+1$ の最小値を求めよ。", answer: ["1"] },
            { id: 46, text: "$81$ の平方根のうち、負のものを求めよ。", answer: ["-9"] },
            { id: 47, text: "正六角形の1つの内角の大きさは何度か。", answer: ["120"] },
            { id: 48, text: "$30, 45, 60$ の最大公約数を求めよ。", answer: ["15"] },
            { id: 49, text: "コインを3回投げて、少なくとも1回表が出る確率は $a/8$ である。$a$ の値を求めよ。", answer: ["7"] },
            { id: 50, text: "$\\tan 45^\\circ$ の値を求めよ。", answer: ["1"] },
            { id: 51, text: "等差数列 $2, 5, 8, ...$ の公差を求めよ。", answer: ["3"] },
            { id: 52, text: "等比数列 $1, 2, 4, 8, ...$ の第 $8$ 項を求めよ。", answer: ["128"] },
            { id: 53, text: "$y=x^2$ と $y=x+2$ の交点の $x$ 座標の和を求めよ。", answer: ["1"] },
            { id: 54, text: "$x^2-x-12$ を因数分解したとき、$(x-a)(x+b)$ となる。$a,b$ が自然数のとき、$a+b$ の値を求めよ。", answer: ["7"] },
            { id: 55, text: "$\\int_{0}^{3} 2x dx$ の値を求めよ。", answer: ["9"] },
            { id: 56, text: "$\\lim_{n \\to \\infty} \\frac{2n+1}{n}$ の値を求めよ。", answer: ["2"] },
            { id: 57, text: "$2^{x} = 64$ を満たす $x$ の値を求めよ。", answer: ["6"] },
            { id: 58, text: "$\\sqrt{2}$ の近似値を小数第1位まで求め、$10$ 倍した整数値を答えよ。（例：1.4なら14）", answer: ["14"] },
            { id: 59, text: "三角形の重心は、中線を $a:b$ に内分する。$a+b$ の値を求めよ。（最も簡単な整数比で）", answer: ["3"] },
            { id: 60, text: "$10$ 円硬貨 $3$ 枚と $100$ 円硬貨 $2$ 枚がある。合計金額は何通りあるか（0円は除く）。", answer: ["11"] },
            { id: 61, text: "$x^2+ax+b=0$ の解が $2, 3$ のとき、$a+b$ の値を求めよ。", answer: ["1"] },
            { id: 62, text: "半径 $r$ の球の体積は $\\frac{4}{3}\\pi r^3$ である。$r=3$ のときの体積を $V=a\\pi$ とするとき、$a$ の値を求めよ。", answer: ["36"] },
            { id: 63, text: "$y = \\sin x$ の周期は $a\\pi$ である。$a$ の値を求めよ。", answer: ["2"] },
            { id: 64, text: "$\\log_3 9 + \\log_3 27$ の値を求めよ。", answer: ["5"] },
            { id: 65, text: "階乗 $0!$ の値を求めよ。", answer: ["1"] },
            { id: 66, text: "正四面体の頂点の数を求めよ。", answer: ["4"] },
            { id: 67, text: "$y=x^2$ を $x$ 軸方向に $2$、$y$ 軸方向に $3$ 平行移動したグラフの頂点の $y$ 座標を求めよ。", answer: ["3"] },
            { id: 68, text: "$1$ から $10$ までの整数の和を求めよ。", answer: ["55"] },
            { id: 69, text: "サイコロを2回投げて、ゾロ目が出る確率は $1/a$ である。$a$ の値を求めよ。", answer: ["6"] },
            { id: 70, text: "$\\vec{a}=(1,2), \\vec{b}=(3,1)$ のとき、$\\vec{a} \\cdot \\vec{b}$（内積）の値を求めよ。", answer: ["5"] }
        ];

        // --- BOT MASTER CONFIG (20 Bots) ---
        const BOT_MASTERS = [
            { name: "神", accuracy: 1.0, finishTime: 120 },
            { name: "バナナ", accuracy: 0.5, finishTime: 110 },
            { name: "むきむきこあら", accuracy: 0.8, finishTime: 160 }, 
            { name: "かわいいだけじゃだめです", accuracy: 0.9, finishTime: 180 },
            { name: "ジャイアントコーン", accuracy: 0.8, finishTime: 200 }, 
            { name: "りんご大福", accuracy: 0.8, finishTime: 220 }, 
            { name: "思考", accuracy: 0.95, finishTime: 240 },
            { name: "おもち", accuracy: 0.6, finishTime: 280 },
            { name: "あ", accuracy: 0.4, finishTime: 290 },
            { name: "Euler_Jr", accuracy: 0.98, finishTime: 140 },
            { name: "猫が好き", accuracy: 0.7, finishTime: 210 },
            { name: "Sevenstars", accuracy: 0.85, finishTime: 190 },
            { name: "田中太郎", accuracy: 0.6, finishTime: 250 },
            { name: "MathWiz", accuracy: 0.9, finishTime: 150 },
            { name: "CoffeeBreak", accuracy: 0.75, finishTime: 230 },
            { name: "X", accuracy: 1.0, finishTime: 130 },
            { name: "焼肉定食", accuracy: 0.65, finishTime: 260 },
            { name: "Algorithm", accuracy: 0.92, finishTime: 170 },
            { name: "Pythagoras", accuracy: 0.95, finishTime: 145 },
            { name: "NoName", accuracy: 0.3, finishTime: 300 }
        ];

        let currentUser = null;
        let currentEventId = null;
        let currentEventEndTime = 0;
        let currentQIndex = 0;
        let userAnswers = [];
        let userProgress = [];
        let isReviewMode = false;
        let adminGridSize = 'md';
        let countdownInterval = null;
        let finishWaitTimer = null;
        let currentQuestions = []; 
        let autoPilotTimer = null;

        const ADMIN_NAME = "admin"; 
        const ADMIN_PASS = "098545";

        const screens = {
            login: document.getElementById('screen-login'), lobby: document.getElementById('screen-lobby'),
            waiting: document.getElementById('screen-waiting'), answer: document.getElementById('screen-answer'),
            finished: document.getElementById('screen-finished'), admin: document.getElementById('screen-admin')
        };

        function showScreen(screenName) {
            Object.values(screens).forEach(el => el.classList.add('hidden-screen'));
            screens[screenName].classList.remove('hidden-screen');
            renderMathInElement(document.body, {delimiters: [{left: '\\[', right: '\\]', display: true}, {left: '$', right: '$', display: false}]});
        }

        // --- AUTH & LOBBY LOGIC ---
        document.getElementById('btn-login').addEventListener('click', async () => {
            const name = document.getElementById('input-username').value.trim();
            const pass = document.getElementById('input-passcode').value.trim();
            if (!name || !pass) return alert("入力してください");
            if (name === ADMIN_NAME && pass === ADMIN_PASS) { initAdminDashboard(); showScreen('admin'); return; }

            const userId = name + "_" + pass;
            const userRef = ref(db, 'users/' + userId);
            try {
                let snapshot = await get(userRef);
                if (!snapshot.exists()) {
                    currentUser = { uid: userId, name: name, passcode: pass, rate: 1000, createdAt: Date.now() };
                    await set(userRef, currentUser);
                } else { currentUser = snapshot.val(); }
                setupLobby(); showScreen('lobby');
            } catch (e) { alert("Login Error"); }
        });

        window.backToLobby = () => {
            if(!currentUser) return location.reload();
            setupLobby();
            showScreen('lobby');
        };

        function setupLobby() {
            document.getElementById('lobby-username').innerText = currentUser.name;
            document.getElementById('lobby-rate').innerText = Math.floor(currentUser.rate);
            
            onValue(ref(db, `users/${currentUser.uid}`), (snap) => {
                if(!snap.exists()) { alert("管理者により削除されました。"); location.reload(); }
                else { currentUser = snap.val(); document.getElementById('lobby-rate').innerText = Math.floor(currentUser.rate); }
            });

            onValue(ref(db, 'events'), (snap) => {
                const activeContainer = document.getElementById('event-list-active');
                const archiveContainer = document.getElementById('event-list-archive');
                activeContainer.innerHTML = ""; archiveContainer.innerHTML = "";
                
                if (!snap.exists()) {
                    activeContainer.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">現在募集中のイベントはありません。</div>';
                    return;
                }
                const events = snap.val();
                const sortedKeys = Object.keys(events).sort((a,b) => events[b].startTime - events[a].startTime);

                const activeKeys = []; const archiveKeys = [];
                sortedKeys.forEach(key => {
                    if(events[key].status === 'finished') archiveKeys.push(key);
                    else activeKeys.push(key);
                });

                if(activeKeys.length === 0) activeContainer.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">現在募集中のイベントはありません。</div>';
                else activeKeys.forEach(key => activeContainer.innerHTML += generateEventCardHTML(key, events[key], currentUser.rate, false));
                
                archiveKeys.forEach(key => archiveContainer.innerHTML += generateEventCardHTML(key, events[key], currentUser.rate, false));
                
                updateCardTimers(events);
            });
        }

        setInterval(() => {
            const timerElements = document.querySelectorAll('.card-timer-active');
            timerElements.forEach(el => {
                const endTime = parseInt(el.dataset.endTime);
                const left = endTime - Date.now();
                if(left > 0) {
                    const m = Math.floor(left / 60000); const s = Math.floor((left % 60000) / 1000);
                    el.innerText = `残り: ${m}:${String(s).padStart(2,'0')}`;
                } else { el.innerText = "集計中"; }
            });
        }, 1000);

        function updateCardTimers(events) {}

        function generateEventCardHTML(key, evt, userRate, isAdmin = false) {
            const minRate = evt.minRate || 0;
            const d = new Date(evt.startTime);
            const dateStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            const endTime = evt.startTime + (evt.duration * 60000);
            
            let btn = ""; let cardBg = "bg-white border-gray-100"; let timerHtml = "";

            if(isAdmin) {
                const isSelected = (key === currentEventId);
                cardBg = isSelected ? "bg-blue-50" : (evt.status === 'finished' ? "bg-gray-100" : "bg-white border-gray-200 hover:bg-gray-50 cursor-pointer");
                let statusText = ""; let statusClass = "text-[10px] font-bold px-2 py-0.5 rounded ml-2 ";
                if (evt.status === 'waiting') { statusText = "予定"; statusClass += "bg-yellow-100 text-yellow-800"; }
                else if (evt.status === 'playing') { statusText = "進行中"; statusClass += "bg-blue-100 text-blue-800 animate-pulse"; }
                else if (evt.status === 'judging') { statusText = "集計中"; statusClass += "bg-purple-100 text-purple-800"; }
                else { statusText = "終了"; statusClass += "bg-gray-200 text-gray-500"; }

                if(evt.status === 'playing') timerHtml = `<span class="text-[10px] font-mono text-red-500 font-bold block text-right card-timer-active" data-end-time="${endTime}">--:--</span>`;

                let displayTitle = evt.title;
                if(displayTitle.length > 16) displayTitle = displayTitle.substring(0, 16) + "...";

                return `<div onclick="window.selectAdminEvent('${key}')" class="${cardBg} rounded-lg p-3 shadow-sm border transition mb-2">
                    <div class="flex justify-between items-start">
                        <div><h4 class="text-sm font-bold truncate w-32" title="${evt.title}">${displayTitle}</h4><div class="flex items-center mt-1"><span class="text-[10px] font-mono text-gray-400">${dateStr}</span></div></div>
                        <div class="flex flex-col items-end"><span class="${statusClass} mb-1">${statusText}</span>${timerHtml}</div>
                    </div>
                </div>`;
            } else {
                const canJoin = userRate >= minRate;
                if (evt.status === "waiting") {
                    btn = canJoin ? `<button onclick="window.joinEvent('${key}')" class="bg-white border-2 border-gray-900 text-gray-900 hover:bg-gray-900 hover:text-white font-bold py-2 px-4 rounded text-xs transition">参加待機</button>` : `<span class="text-xs text-red-400 font-bold">参加条件：レート${minRate}以上</span>`;
                } else if (evt.status === "playing") {
                    btn = `<button class="bg-gray-100 text-gray-400 font-bold py-2 px-4 rounded text-xs cursor-not-allowed">進行中</button>`;
                    timerHtml = `<span class="text-xs font-mono text-red-500 font-bold block mt-1 card-timer-active" data-end-time="${endTime}">--:--</span>`;
                } else if (evt.status === "finished") {
                    cardBg = "bg-gray-100 border-gray-200";
                    btn = `<button onclick="window.viewArchive('${key}')" class="bg-gray-200 text-gray-600 hover:bg-gray-300 font-bold py-2 px-4 rounded text-xs">過去問を見る</button>`;
                } else { btn = `<button class="bg-gray-100 text-gray-400 font-bold py-2 px-4 rounded text-xs cursor-not-allowed">集計中</button>`; }

                return `<div class="${cardBg} rounded-lg p-4 shadow-sm border mb-3 flex justify-between items-center">
                    <div><div class="flex items-center space-x-2 mb-1"><span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-0.5 rounded">EVENT</span><span class="text-[10px] font-mono text-gray-400">${dateStr}</span></div><h4 class="text-base font-bold">${evt.title}</h4><div class="flex items-center mt-1">${timerHtml}</div></div>
                    <div class="text-right">${btn}</div>
                </div>`;
            }
        }

        window.joinEvent = async (eventId) => {
            if(currentEventId && currentEventId !== eventId) await remove(ref(db, `events/${currentEventId}/participants/${currentUser.uid}`));
            isReviewMode = false; currentEventId = eventId;
            const evtSnap = await get(ref(db, `events/${eventId}`));
            const evt = evtSnap.val();
            
            if(evt.questionIds) {
                currentQuestions = evt.questionIds.map(qid => QUESTION_BANK.find(q => q.id === qid)).filter(q=>q);
            } else {
                currentQuestions = QUESTION_BANK.slice(0,5); 
            }

            userAnswers = new Array(currentQuestions.length).fill("");
            userProgress = new Array(currentQuestions.length).fill(false);

            currentEventEndTime = evt.startTime + (evt.duration * 60 * 1000);
            
            await set(ref(db, `events/${eventId}/participants/${currentUser.uid}`), { name: currentUser.name, rate: currentUser.rate, joinedAt: Date.now(), progress: userProgress });
            showScreen('waiting');
            
            // Render Participant List in Waiting Screen (Live) - SORTED
            onValue(ref(db, `events/${eventId}/participants`), (snap) => {
                const listEl = document.getElementById('waiting-participant-list');
                listEl.innerHTML = "";
                if(snap.exists()) {
                    const parts = snap.val();
                    const sortedParts = Object.values(parts).sort((a,b) => (b.rate||1000) - (a.rate||1000));
                    sortedParts.forEach(p => {
                        const rateDisplay = p.rate ? `レート${Math.floor(p.rate)}` : "-";
                        listEl.innerHTML += `
                        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center animate-fade-in">
                            <span class="font-bold text-gray-700 truncate w-32">${p.name}</span>
                            <span class="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-1 rounded-full">${rateDisplay}</span>
                        </div>`;
                    });
                }
            });

            if(countdownInterval) clearInterval(countdownInterval);
            const timerEl = document.getElementById('countdown');
            countdownInterval = setInterval(() => {
                const diff = evt.startTime - Date.now();
                if(diff <= 0) { timerEl.innerText = "00:00"; clearInterval(countdownInterval); } 
                else { const m = Math.floor(diff / 60000); const s = Math.floor((diff % 60000) / 1000); timerEl.innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
            }, 1000);

            onValue(ref(db, `events/${eventId}/status`), (snap) => {
                const s = snap.val();
                if (s === "playing") { 
                    initGame(); showScreen('answer'); 
                    document.getElementById('screen-answer').classList.remove('review-mode'); 
                    document.getElementById('review-badge').classList.add('hidden'); 
                    document.getElementById('btn-back-lobby-review').classList.add('hidden'); 
                    document.getElementById('keypad-area').style.display = 'flex'; 
                    document.getElementById('answer-timer-display').classList.remove('hidden'); 
                }
                if (s === "judging") { resetFinishedScreen(); showScreen('finished'); }
                if (s === "finished") { showPersonalResult(); } 
            });

            // Listen for progress to show in finished screen (Waiting for others)
            onValue(ref(db, `events/${eventId}/participants`), (snap) => {
                const finishListContainer = document.getElementById('finished-participant-list-container');
                const finishList = document.getElementById('finished-participant-list');
                if(!document.getElementById('screen-finished').classList.contains('hidden-screen') && snap.exists()) {
                     finishList.innerHTML = "";
                     const parts = snap.val();
                     Object.values(parts).forEach(p => {
                         let squares = (p.progress||[]).map(d => `<div class="w-2.5 h-2.5 rounded-sm ${d?'bg-blue-600':'bg-gray-200'}"></div>`).join('');
                         finishList.innerHTML += `
                         <div class="bg-white p-2 rounded border border-gray-100 flex justify-between items-center">
                             <span class="text-xs font-bold text-gray-700 truncate flex-1 mr-2">${p.name}</span>
                             <div class="flex gap-0.5 flex-shrink-0">${squares}</div>
                         </div>`;
                     });
                     finishListContainer.classList.remove('hidden');
                }
            });
        };

        window.leaveEventAndBack = async () => {
            if(currentEventId) { if(countdownInterval) clearInterval(countdownInterval); await remove(ref(db, `events/${currentEventId}/participants/${currentUser.uid}`)); currentEventId = null; }
            backToLobby();
        };

        window.viewArchive = async (eventId) => {
            isReviewMode = true; const evtSnap = await get(ref(db, `events/${eventId}`)); const evt = evtSnap.val();
            if(evt.questionIds) currentQuestions = evt.questionIds.map(qid => QUESTION_BANK.find(q => q.id === qid)).filter(q=>q);
            else currentQuestions = QUESTION_BANK.slice(0,5);
            
            currentQIndex = 0; 
            userAnswers = new Array(currentQuestions.length).fill(""); 
            userProgress = new Array(currentQuestions.length).fill(false);
            
            showScreen('answer');
            document.getElementById('screen-answer').classList.add('review-mode'); document.getElementById('review-badge').classList.remove('hidden'); document.getElementById('btn-back-lobby-review').classList.remove('hidden'); document.getElementById('btn-back-lobby-review').onclick = window.backToLobby; document.getElementById('answer-timer-display').classList.add('hidden'); document.getElementById('keypad-area').style.display = 'none';
            renderQuestion(); updateNavBubbles();
        };

        let answerTimer = null;
        function initGame() {
            currentQIndex = 0; 
            userAnswers = new Array(currentQuestions.length).fill(""); 
            userProgress = new Array(currentQuestions.length).fill(false);
            renderQuestion(); updateNavBubbles();
            if(answerTimer) clearInterval(answerTimer);
            const display = document.getElementById('answer-timer-display');
            answerTimer = setInterval(() => {
                const left = currentEventEndTime - Date.now();
                if(left <= 0) { display.innerText = "00:00"; clearInterval(answerTimer); } 
                else { const m = Math.floor(left/60000); const s = Math.floor((left%60000)/1000); display.innerText = `${m}:${String(s).padStart(2,'0')}`; }
            }, 1000);
        }

        function renderQuestion() {
            const q = currentQuestions[currentQIndex];
            document.getElementById('display-q-num').innerText = currentQIndex + 1;
            const pel = document.getElementById('problem-text');
            pel.innerText = `${q.text}`; 
            renderMathInElement(pel, {delimiters: [{left: '$', right: '$', display: false}]});
            
            if(!isReviewMode) {
                const val = userAnswers[currentQIndex];
                document.getElementById('answer-input').value = val;
                window.updateMathInput(val);
            } else {
                document.getElementById('answer-input').value = "";
                window.updateMathInput("");
            }
        }

        window.kp = (char) => {
            const input = document.getElementById('answer-input');
            if(char === 'BS') input.value = input.value.slice(0, -1); else input.value += char;
            window.updateMathInput(input.value);
        };

        document.addEventListener('keydown', (e) => {
            if(document.getElementById('screen-answer').classList.contains('hidden-screen') || isReviewMode) return;
            const validChars = "0123456789-,.";
            if (validChars.includes(e.key)) window.kp(e.key);
            else if (e.key === "Backspace") window.kp('BS');
            else if (e.key === "Enter") window.submitCurrentAnswer();
        });

        window.navQuestion = (diff) => {
            const next = currentQIndex + diff;
            if (next >= 0 && next < currentQuestions.length) { 
                if(!isReviewMode) userAnswers[currentQIndex] = document.getElementById('answer-input').value; 
                currentQIndex = next; renderQuestion(); updateNavBubbles(); 
            }
        };
        window.updateMathInput = (v) => {
            const overlay = document.getElementById('math-overlay');
            if(!v) { overlay.innerText = ""; return; }
            try { katex.render(v, overlay, { throwOnError: false }); } catch(e) { overlay.innerText = v; }
        };
        window.updateNavBubbles = () => {
            const c = document.getElementById('nav-bubbles'); c.innerHTML = "";
            for(let i=0; i<currentQuestions.length; i++) {
                let cls = i === currentQIndex ? "border-2 border-blue-600 text-blue-600" : "border border-gray-300 text-gray-400";
                if(isReviewMode) cls = i === currentQIndex ? "border-2 border-gray-600 text-gray-600" : "border border-gray-300 text-gray-400";
                let dot = userProgress[i] ? `<span class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-white bg-green-500"></span>` : "";
                c.innerHTML += `<button class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm bg-white relative ${cls} flex-shrink-0" onclick="window.navQuestion(${i - currentQIndex})">${i+1}${dot}</button>`;
            }
        }
        window.submitCurrentAnswer = async () => {
            const val = document.getElementById('answer-input').value.trim();
            if (!val) return;
            userAnswers[currentQIndex] = val; userProgress[currentQIndex] = true;
            await set(ref(db, `events/${currentEventId}/participants/${currentUser.uid}/progress`), userProgress);
            await set(ref(db, `answers/${currentEventId}/${currentUser.uid}/q${currentQIndex+1}`), val);
            updateNavBubbles();
            if (userProgress.every(Boolean)) { 
                if(confirm("完了して待機画面に移動しますか？\n※待機画面からは戻ることができません。")) { 
                    resetFinishedScreen(); showScreen('finished'); 
                } 
            }
            else { const next = userProgress.findIndex((p,i)=>!p&&i>currentQIndex); window.navQuestion(next!==-1 ? next-currentQIndex : 1); }
        };

        function resetFinishedScreen() {
            document.getElementById('user-status-msg').innerText = "集計中";
            document.getElementById('user-status-msg').className = "animate-pulse bg-blue-100 text-blue-600 px-4 py-1 rounded-full text-sm font-bold";
            document.getElementById('personal-result-area').classList.add('hidden');
            document.getElementById('finished-waiting-header').classList.remove('hidden'); // Show header with timer
            document.getElementById('finished-participant-list-container').classList.remove('hidden'); 

            // Start Waiting Timer
            if(finishWaitTimer) clearInterval(finishWaitTimer);
            const tEl = document.getElementById('finish-wait-timer');
            finishWaitTimer = setInterval(() => {
                const left = currentEventEndTime - Date.now();
                if(left <= 0) { tEl.innerText = "00:00"; clearInterval(finishWaitTimer); }
                else { const m = Math.floor(left/60000); const s = Math.floor((left%60000)/1000); tEl.innerText = `${m}:${String(s).padStart(2,'0')}`; }
            }, 1000);
        }

        async function showPersonalResult() {
            showScreen('finished');
            document.getElementById('user-status-msg').innerText = "結果発表 / Results Released";
            document.getElementById('user-status-msg').className = "bg-green-100 text-green-700 px-4 py-1 rounded-full text-sm font-bold";
            document.getElementById('finished-participant-list-container').classList.add('hidden'); 
            document.getElementById('finished-waiting-header').classList.add('hidden'); // Hide timer
            if(finishWaitTimer) clearInterval(finishWaitTimer);

            const area = document.getElementById('personal-result-area');
            const list = document.getElementById('answer-review-list');
            
            const rankSnap = await get(ref(db, `events/${currentEventId}/ranking`));
            const ansSnap = await get(ref(db, `answers/${currentEventId}/${currentUser.uid}`));
            if(!rankSnap.exists()) return;
            const ranking = rankSnap.val();
            const myData = ranking.find(r => r.uid === currentUser.uid);
            const myAnswers = ansSnap.exists() ? ansSnap.val() : {};

            if(myData) {
                // Client side update for display immediately, though admin also updates it
                await update(ref(db, `users/${currentUser.uid}`), { rate: myData.newRate });
                document.getElementById('my-rank-disp').innerText = myData.rank + "位";
                document.getElementById('my-rate-disp').innerText = Math.floor(myData.newRate);
                const diff = myData.rateDiff > 0 ? `(+${myData.rateDiff})` : `(${myData.rateDiff})`;
                document.getElementById('my-rate-diff').innerText = diff;
                
                list.innerHTML = "";
                currentQuestions.forEach((q, i) => {
                    const qKey = `q${i+1}`;
                    const myAns = myAnswers[qKey] || "(未回答)";
                    const isCorrect = myData.results[i]; 
                    const resultBadge = isCorrect 
                        ? `<span class="text-green-600 font-bold text-xs border border-green-200 bg-green-50 px-2 py-0.5 rounded">正解</span>`
                        : `<span class="text-red-500 font-bold text-xs border border-red-200 bg-red-50 px-2 py-0.5 rounded">不正解</span>`;
                    list.innerHTML += `
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2"><span class="text-xs font-mono text-gray-400">Q.${i+1}</span>${resultBadge}</div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><p class="text-[10px] text-gray-400 uppercase">あなたの解答</p><p class="font-mono text-gray-800 break-all">\\(${myAns}\\)</p></div>
                            <div><p class="text-[10px] text-gray-400 uppercase">正解</p><p class="font-mono text-blue-600 break-all">\\(${q.answer[0]}\\)</p></div>
                        </div>
                    </div>`;
                });
                renderMathInElement(list, {delimiters: [{left: '\\(', right: '\\)', display: false}]});
                area.classList.remove('hidden');
            }
        }

        // --- ADMIN & BOT LOGIC ---
        function initAdminDashboard() {
            const grid = document.getElementById('admin-grid');
            const formContainer = document.getElementById('create-event-form');
            const toggleBtn = document.getElementById('btn-toggle-create');
            const qrCode = document.getElementById('qr-code');
            const statusHeader = document.getElementById('admin-status-header');

            qrCode.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.href)}`;
            toggleBtn.onclick = () => {
                formContainer.classList.toggle('hidden');
                toggleBtn.innerText = formContainer.classList.contains('hidden') ? "＋ 新規イベント作成" : "× 閉じる";
            };
            
            document.getElementById('btn-create-event').onclick = async () => {
                const title = document.getElementById('new-evt-title').value;
                const timeStr = document.getElementById('new-evt-time').value;
                const duration = parseInt(document.getElementById('new-evt-duration').value) || 5;
                const rate = parseInt(document.getElementById('new-evt-rate').value) || 0;
                
                // ★ Get Custom Question Count
                const qCountInput = parseInt(document.getElementById('new-evt-qcount').value) || 5;
                const actualCount = Math.min(Math.max(qCountInput, 1), 20); 

                if(!title || !timeStr) return alert("入力エラー");
                const startTime = new Date(timeStr).getTime();
                const eventId = "evt_" + Math.floor(Date.now() / 1000);
                
                // Select N random questions
                const shuffled = [...QUESTION_BANK].sort(() => 0.5 - Math.random());
                const selectedIds = shuffled.slice(0, actualCount).map(q => q.id);

                await set(ref(db, `events/${eventId}`), {
                    title: title, startTime: startTime, duration: duration, minRate: rate,
                    status: "waiting", participants: {},
                    questionIds: selectedIds 
                });
                
                // ★ NEW BOT LOGIC
                // 1. Determine number of bots (1-5)
                const numBots = Math.floor(Math.random() * 5) + 1;

                // 2. Check currently active events to exclude busy bots
                const eventsSnap = await get(ref(db, 'events'));
                const activeBotNames = new Set();
                if (eventsSnap.exists()) {
                    Object.values(eventsSnap.val()).forEach(evt => {
                        if (evt.status !== 'finished' && evt.participants) {
                            Object.values(evt.participants).forEach(p => {
                                if (p.isBot) activeBotNames.add(p.name);
                            });
                        }
                    });
                }

                // 3. Filter available bots
                const availableBots = BOT_MASTERS.filter(b => !activeBotNames.has(b.name));
                // Fallback if too many busy: just pick from all (or reduce count)
                const pool = availableBots.length >= numBots ? availableBots : BOT_MASTERS;
                
                const selectedBots = [...pool].sort(() => 0.5 - Math.random()).slice(0, numBots);

                // 4. Calculate timing (Scatter within last 3 mins or now->start)
                const now = Date.now();
                const threeMinBefore = startTime - (3 * 60 * 1000);
                // Earliest entry is either 3 mins before start, or now (if created late)
                const entryStartWindow = Math.max(now, threeMinBefore);
                const windowDuration = Math.max(0, startTime - entryStartWindow);

                selectedBots.forEach((bot) => {
                    // Random delay within the allowed window
                    const randomDelay = Math.random() * windowDuration;
                    const joinTime = entryStartWindow + randomDelay;
                    const delayFromNow = Math.max(0, joinTime - now);

                    setTimeout(async () => {
                        const botId = "bot_" + bot.name;
                        // Ensure bot exists in users
                        const botUserRef = ref(db, `users/${botId}`);
                        const botSnap = await get(botUserRef);
                        const currentBotRate = botSnap.exists() ? botSnap.val().rate : 1000;
                        if(!botSnap.exists()) await set(botUserRef, { uid: botId, name: bot.name, rate: 1000 });
                        // Add to participants
                        await update(ref(db, `events/${eventId}/participants/${botId}`), { name: bot.name, rate: currentBotRate, isBot: true, accuracy: bot.accuracy, finishTime: bot.finishTime, progress: new Array(selectedIds.length).fill(false) });
                    }, delayFromNow); 
                });

                alert("作成完了。");
                formContainer.classList.add('hidden');
                toggleBtn.innerText = "＋ 新規イベント作成";
            };

            onValue(ref(db, 'events'), (snap) => {
                const adminList = document.getElementById('admin-event-list');
                if(!snap.exists()) { adminList.innerHTML = ""; return; }
                const events = snap.val();
                const sortedKeys = Object.keys(events).sort((a,b) => events[b].startTime - events[a].startTime);
                if(!currentEventId && sortedKeys.length > 0) watchEvent(sortedKeys[0]);
                else if(currentEventId && !events[currentEventId]) {
                    if(sortedKeys.length > 0) watchEvent(sortedKeys[0]); else currentEventId = null;
                }
                adminList.innerHTML = "";
                sortedKeys.forEach(key => { adminList.innerHTML += generateEventCardHTML(key, events[key], -1, true); });
            });

            window.selectAdminEvent = (key) => {
                watchEvent(key);
                get(ref(db, 'events')).then(snap => {
                    if(snap.exists()) {
                        const events = snap.val();
                        const sortedKeys = Object.keys(events).sort((a,b) => events[b].startTime - events[a].startTime);
                        const adminList = document.getElementById('admin-event-list');
                        adminList.innerHTML = "";
                        sortedKeys.forEach(k => { adminList.innerHTML += generateEventCardHTML(k, events[k], -1, true); });
                    }
                });
            };

            window.setGridSize = (size) => {
                adminGridSize = size;
                const grid = document.getElementById('admin-grid');
                if(size === 'lg') grid.className = "grid grid-cols-2 gap-4 content-start pt-4 px-2";
                else if(size === 'md') grid.className = "grid grid-cols-3 md:grid-cols-4 gap-3 content-start pt-4 px-2";
                else grid.className = "grid grid-cols-4 md:grid-cols-6 gap-2 content-start pt-4 px-2";
                
                if(currentEventId) window.selectAdminEvent(currentEventId);
            }

            // ★ Kick Function (Enhanced & Fixed) ★
            window.kickUser = async (uid, name) => {
                if(!confirm(`ユーザー「${name}」を削除しますか？\n（イベントから強制退出させます）`)) return;
                if(!confirm(`本当に削除しますか？`)) return;
                const card = document.getElementById(`grid-card-${uid}`);
                if(card) card.remove();
                const updates = {};
                updates[`events/${currentEventId}/participants/${uid}`] = null;
                updates[`answers/${currentEventId}/${uid}`] = null;
                updates[`users/${uid}`] = null;
                await update(ref(db), updates);
            };

            let autoPilotTimer = null;
            let currentEventData = null; 

            function watchEvent(eventId) {
                currentEventId = eventId;
                const grid = document.getElementById('admin-grid');
                grid.innerHTML = ""; 
                if(autoPilotTimer) clearInterval(autoPilotTimer);

                autoPilotTimer = setInterval(() => {
                    if(!currentEventData) return;
                    if(currentEventData.status === 'waiting' && Date.now() >= currentEventData.startTime) {
                        if(!currentEventData.participants || Object.keys(currentEventData.participants).length === 0) {
                            remove(ref(db, `events/${eventId}`)); return;
                        }
                        update(ref(db, `events/${eventId}`), {status: 'playing'});
                    }
                    if(currentEventData.status === 'playing') {
                        const endTime = currentEventData.startTime + (currentEventData.duration * 60 * 1000);
                        const left = endTime - Date.now();
                        
                        // Check if ALL participants finished
                        const parts = currentEventData.participants || {};
                        const allFinished = Object.keys(parts).length > 0 && Object.values(parts).every(p => p.progress && p.progress.every(b => b));

                        if(left <= 0 || allFinished) stopAndJudge(eventId); 
                        // ★ BOT SOLVING LOGIC INJECTION
                        Object.entries(currentEventData.participants || {}).forEach(([uid, p]) => {
                            if(p.isBot) simulateBotSolving(eventId, uid, p, currentEventData.questionIds);
                        });
                    }
                }, 1000);

                onValue(ref(db, `events/${eventId}`), (snap) => {
                    if(!snap.exists()) {
                        grid.innerHTML = '<p class="text-xs text-gray-400 p-2">Event deleted or not found.</p>';
                        statusHeader.innerHTML = `0<span class="text-sm font-sans font-normal text-gray-500 ml-1">人</span>`;
                        return;
                    }
                    const evt = snap.val();
                    currentEventData = evt; 
                    const pCount = evt.participants ? Object.keys(evt.participants).length : 0;
                    let statusText = "人 待機中";
                    if(evt.status === 'playing') statusText = "人 挑戦中";
                    if(evt.status === 'judging') statusText = "人 集計中";
                    if(evt.status === 'finished') statusText = "人 終了";
                    statusHeader.innerHTML = `${pCount}<span class="text-sm font-sans font-normal text-gray-500 ml-1">${statusText}</span>`;

                    const sizeClasses = {
                        'lg': { card: 'p-4', name: 'text-lg', sq: 'w-5 h-5' },
                        'md': { card: 'p-3', name: 'text-base', sq: 'w-3.5 h-3.5' },
                        'sm': { card: 'p-2', name: 'text-sm', sq: 'w-2.5 h-2.5' }
                    };
                    const s = sizeClasses[adminGridSize];

                    if(evt.ranking) {
                        const ranking = evt.ranking;
                        if(!document.querySelector('.reveal-row')) {
                            grid.innerHTML = "";
                            ranking.forEach(r => {
                                let squares = r.results.map(res => `<div class="${s.sq} rounded-sm ${res?'bg-correct':'bg-wrong'}"></div>`).join('');
                                grid.innerHTML += `
                                <div id="grid-card-${r.uid}" onclick="window.kickUser('${r.uid}', '${r.name}')" class="${s.card} rounded bg-white border border-gray-100 shadow-sm flex flex-col justify-between gap-2 cursor-pointer hover:bg-red-50 hover:border-red-300 transition duration-200" title="クリックして削除">
                                    <div class="font-bold text-gray-700 truncate ${s.name}">${r.name}</div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-400 font-mono text-xs">${r.rank}位</span>
                                        <div class="flex flex-wrap gap-0.5 justify-end">${squares}</div>
                                    </div>
                                </div>`;
                            });
                        }
                    } else if(evt.participants) {
                        Object.entries(evt.participants).forEach(([uid, p]) => {
                            if(!document.getElementById(`grid-card-${uid}`)) {
                                let squares = (p.progress||[]).map(d => `<div class="${s.sq} rounded-sm ${d?'bg-blue-600':'bg-gray-200'}"></div>`).join('');
                                let readyText = p.rate ? `レート${Math.floor(p.rate)}` : "READY";
                                const html = `
                                <div id="grid-card-${uid}" onclick="window.kickUser('${uid}', '${p.name}')" class="${s.card} rounded bg-white border border-gray-100 shadow-sm flex flex-col justify-between gap-2 cursor-pointer hover:bg-red-50 hover:border-red-300 transition duration-200" title="クリックして削除">
                                    <div class="font-bold text-gray-700 truncate ${s.name}">${p.name}</div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-400 font-mono text-xs">${readyText}</span>
                                        <div class="flex flex-wrap gap-0.5 justify-end">${squares}</div>
                                    </div>
                                </div>`;
                            }
                        });
                        grid.innerHTML = "";
                        Object.entries(evt.participants).forEach(([uid, p]) => {
                             let squares = (p.progress||[]).map(d => `<div class="${s.sq} rounded-sm ${d?'bg-blue-600':'bg-gray-200'}"></div>`).join('');
                             let readyText = p.rate ? `レート${Math.floor(p.rate)}` : "READY";
                             grid.innerHTML += `
                                <div id="grid-card-${uid}" onclick="window.kickUser('${uid}', '${p.name}')" class="${s.card} rounded bg-white border border-gray-100 shadow-sm flex flex-col justify-between gap-2 cursor-pointer hover:bg-red-50 hover:border-red-300 transition duration-200" title="クリックして削除">
                                    <div class="font-bold text-gray-700 truncate ${s.name}">${p.name}</div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-400 font-mono text-xs">${readyText}</span>
                                        <div class="flex flex-wrap gap-0.5 justify-end">${squares}</div>
                                    </div>
                                </div>`;
                        });
                    } else {
                        grid.innerHTML = '<p class="text-xs text-gray-300 p-4">No participants yet.</p>';
                    }
                });
            }

            // ★ Bot Simulation Logic
            async function simulateBotSolving(eventId, botId, bot, questionIds) {
                if(!bot.progress) bot.progress = new Array(questionIds.length).fill(false);
                const nextQIndex = bot.progress.indexOf(false);
                if(nextQIndex === -1) return;

                // ★ Speed Constraint: 3s check (Saved in Firebase per bot participant)
                if (bot.lastAnswerTime && (Date.now() - bot.lastAnswerTime < 3000)) return;
                
                // Calculate random chance based on target finish time
                // Tick is 1s approx (in loop). Probability P = 1 / (TimePerQ)
                const timePerQuestion = bot.finishTime / questionIds.length;
                const solveChance = 2.0 / timePerQuestion; 

                if(Math.random() < solveChance) {
                    bot.progress[nextQIndex] = true;
                    const isCorrect = Math.random() < bot.accuracy;
                    const q = QUESTION_BANK.find(qb => qb.id === questionIds[nextQIndex]);
                    const answer = isCorrect ? q.answer[0] : "0";
                    await update(ref(db, `events/${eventId}/participants/${botId}`), { progress: bot.progress, lastAnswerTime: Date.now() });
                    await set(ref(db, `answers/${eventId}/${botId}/q${nextQIndex+1}`), answer);
                }
            }

            async function stopAndJudge(eventId) {
                if(autoPilotTimer) clearInterval(autoPilotTimer);
                autoPilotTimer = null;
                await update(ref(db, `events/${eventId}`), {status:'judging'});
                const answers = (await get(ref(db, `answers/${eventId}`))).val() || {};
                const participants = (await get(ref(db, `events/${eventId}/participants`))).val() || {};
                const allUsers = (await get(ref(db, `users`))).val() || {};
                const evtSnap = await get(ref(db, `events/${eventId}`));
                const evt = evtSnap.val();
                const judgeQuestions = (evt.questionIds||[]).map(qid => QUESTION_BANK.find(q=>q.id===qid)).filter(q=>q);
                
                // Use actual question count
                const qLen = judgeQuestions.length || 5;

                let userResults = [];
                Object.keys(participants).forEach(uid => {
                    const p = participants[uid];
                    const uAnsObj = answers[uid] || {};
                    let correctCount = 0;
                    let results = [];
                    for(let i=0; i<qLen; i++) {
                        const uAns = (uAnsObj[`q${i+1}`] || "").replace(/\s+/g, '');
                        const valids = judgeQuestions[i] ? judgeQuestions[i].answer.map(a => a.replace(/\s+/g, '')) : [];
                        const isCorrect = valids.includes(uAns);
                        results.push(isCorrect);
                        if(isCorrect) correctCount++;
                    }
                    userResults.push({ uid, name: p.name, results, correctCount });
                });
                
                // Prepare multi-path update for ratings
                const updates = {};
                userResults = userResults.map(u => {
                    let score = u.correctCount * 100;
                    u.score = score;
                    const curRate = (allUsers[u.uid] && allUsers[u.uid].rate) || 1000;
                    const diff = Math.floor(score * 0.1);
                    u.newRate = curRate + diff;
                    u.rateDiff = diff;

                    // ★ Update actual rate in users table (Important for bots)
                    updates[`users/${u.uid}/rate`] = u.newRate;
                    return u;
                });
                if(Object.keys(updates).length > 0) await update(ref(db), updates);

                userResults.sort((a,b) => b.score - a.score);
                userResults.forEach((u,i) => u.rank = i+1);
                
                await set(ref(db, `events/${eventId}/ranking`), userResults);
                setTimeout(() => { startReveal(eventId); }, 10000);
            }

            async function startReveal(eventId) {
                const ranking = (await get(ref(db, `events/${eventId}/ranking`))).val();
                if(!ranking) return;
                
                window.setGridSize(adminGridSize);

                ranking.forEach(r => {
                    const s = { 'lg': {sq:'w-5 h-5'}, 'md': {sq:'w-3.5 h-3.5'}, 'sm': {sq:'w-2.5 h-2.5'} }[adminGridSize];
                    let squares = r.results.map(res => `<div class="${s.sq} rounded-sm bg-gray-200 transition-colors duration-500" data-res="${res}"></div>`).join('');
                });
                
                let i = ranking.length - 1;
                const interval = setInterval(() => {
                    if(i < 0) { clearInterval(interval); update(ref(db, `events/${eventId}`), {status:'finished'}); return; }
                    const user = ranking[i];
                    i--;
                }, 1200);
            }

            document.getElementById('btn-stop-duel').onclick = () => { if(confirm("強制終了しますか？")) stopAndJudge(currentEventId); };
            document.getElementById('btn-reveal').onclick = () => { if(confirm("強制発表しますか？")) startReveal(currentEventId); };
            
            window.setGridSize('md');
        }
    </script>
</body>
</html>